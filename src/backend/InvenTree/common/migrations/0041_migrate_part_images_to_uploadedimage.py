# Generated by Django 4.2.22 on 2025-06-30 15:22
'''
Migration to copy the image file from the Part model into the UploadedImage model.
'''

import os
from django.db import migrations
from django.core.files.base import ContentFile



def forwards(apps, schema_editor):
    Part = apps.get_model('part', 'Part')
    UploadedImage = apps.get_model('common', 'UploadedImage')

    for part in Part.objects.all():
        if not part.image:
            continue

        try:
            part.image.open('rb')
        except Exception:
            # If file is missing or corrupted, skip this Part
            continue

        # Read binary data and close the file
        data = part.image.read()
        part.image.close()

        # Extract the base filename to avoid path issues
        filename = os.path.basename(part.image.name)
        new_img = UploadedImage(
            model_type='part',    
            model_id=part.pk,
            primary=True,
        )
        new_img.image.save(filename, ContentFile(data), save=True)


def backwards(apps, schema_editor):
    # On rollback, remove all UploadedImage entries created for Parts
    UploadedImage = apps.get_model('common', 'UploadedImage')
    UploadedImage.objects.filter(model_type='part').delete()



class Migration(migrations.Migration):

    dependencies = [
        ('common', '0040_uploadedimage'),
    ]

    operations = [
        migrations.RunPython(forwards, backwards),
    ]