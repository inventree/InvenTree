import{r as o,i as a,j as t,bf as V,aO as Y,S as _,Y as Z,G as z,dT as P,aT as K,B as g,bS as N,n as x,I as Q,d as W,cx as X,bi as q}from"./vendor-c9tu_e1b.js";import{a as f}from"./NotesPanel-B1Mm8XV0.js";import{A as M}from"./ActionButton-Cn3lAMG1.js";import{P as H}from"./index-D1sX3jYA.js";import{u as y,R as ee,a as te,I as ae}from"./InvenTreeTable-_nPJoCLK.js";import{b as se,e as ne,A as oe}from"./index-C-YqHYR0.js";import{A as w}from"./AttachmentLink-BmXuTpAy.js";import{u as re}from"./DesktopAppView-Bg1vO8uy.js";import{b as ie,u as le,a as ce,j as de}from"./UseForm-21BEg7Md.js";function ue(){return[{accessor:"attachment",sortable:!1,switchable:!1,noWrap:!0,render:e=>e.attachment?t.jsx(w,{attachment:e.attachment}):e.link?t.jsx(w,{attachment:e.link,external:!0}):"-",noContext:!0},{accessor:"comment",sortable:!1,render:e=>e.comment},{accessor:"upload_date",sortable:!0,render:e=>t.jsxs(z,{justify:"space-between",children:[t.jsx(g,{children:e.upload_date}),e.user_detail&&t.jsx(N,{size:"xs",children:e.user_detail.username})]})},{accessor:"file_size",sortable:!0,switchable:!0,render:e=>e.attachment?de(e.file_size):"-"}]}function v({filename:e,progress:s}){return t.jsxs(_,{gap:"xs",children:[t.jsx(g,{size:"sm",children:a._({id:"XDpUYO",values:{filename:e}})}),t.jsx(H,{value:s,progressLabel:!1})]})}function me({model_type:e,model_id:s}){const U=re(),r=se(),l=y(`${e}-attachments`),E=o.useMemo(()=>ue(),[]),c=ne(oe.attachment_list),C=o.useMemo(()=>s>0,[s]),j=o.useMemo(()=>r.hasDeletePermission(e),[r,e]),[R,I]=o.useState(!1),B=o.useMemo(()=>r.hasAddPermission(e),[r,e]);function G(n){n.forEach(m=>{const h=new FormData;h.append("attachment",m),h.append("model_type",e),h.append("model_id",s.toString()),I(!0);const A=m.name,p=`attachment-upload-${e}-${s}-${m.name}`;x.show({id:p,title:a._({id:"hIFN6r"}),message:t.jsx(v,{filename:A,progress:0}),color:"blue",loading:!0,autoClose:!1}),U.post(c,h,{timeout:30*1e3,onUploadProgress:i=>{const O=100*((i==null?void 0:i.progress)??0);x.update({id:p,title:a._({id:"hIFN6r"}),color:"blue",loading:!0,autoClose:!1,message:t.jsx(v,{filename:A,progress:O})})}}).then(i=>(x.update({id:p,title:a._({id:"I1EiW4"}),message:a._({id:"JuMBMK",values:{name:A}}),color:"green",autoClose:3500,icon:t.jsx(Q,{}),loading:!1}),l.refreshTable(),i)).catch(i=>(console.error("Error uploading attachment:",m,"->",i),x.update({id:p,title:a._({id:"ae3dey"}),message:a._({id:"GZnmeE"}),color:"red",autoClose:5e3,icon:t.jsx(W,{}),loading:!1}),i)).finally(()=>{I(!1)})})}const[b,S]=o.useState("attachment"),[d,u]=o.useState(void 0),F=o.useMemo(()=>{const n={model_type:{value:e,hidden:!0},model_id:{value:s,hidden:!0},attachment:{},link:{},comment:{}};return b!="link"&&delete n.link,(b!="attachment"||d)&&delete n.attachment,n},[e,s,b,d]),k=ie({url:c,title:a._({id:"p1w/D6"}),fields:F,onFormSuccess:()=>{l.refreshTable()}}),T=le({url:c,pk:d,title:a._({id:"MVvhJ1"}),fields:F,onFormSuccess:n=>{n.pk?l.updateRecord(n):l.refreshTable()}}),D=ce({url:c,pk:d,title:a._({id:"hZfPb3"}),onFormSuccess:()=>{l.refreshTable()}}),L=o.useMemo(()=>[{name:"is_link",label:a._({id:"3QegpG"}),description:a._({id:"r1FQZj"})},{name:"is_file",label:a._({id:"JT83gz"}),description:a._({id:"5LI39K"})}],[]),$=o.useMemo(()=>[t.jsx(M,{tooltip:a._({id:"V8euYO"}),hidden:!r.hasAddPermission(e),icon:t.jsx(V,{}),onClick:()=>{S("attachment"),u(void 0),k.open()}},"add-attachment"),t.jsx(M,{tooltip:a._({id:"DpV4ac"}),hidden:!r.hasAddPermission(e),icon:t.jsx(Y,{}),onClick:()=>{S("link"),u(void 0),k.open()}},"add-external-link")],[r,e]),J=o.useCallback(n=>[ee({hidden:!r.hasChangePermission(e),onClick:()=>{u(n.pk),T.open()}}),te({hidden:!j,onClick:()=>{u(n.pk),D.open()}})],[r,e]);return t.jsxs(t.Fragment,{children:[k.modal,T.modal,D.modal,t.jsxs(_,{gap:"xs",children:[C&&t.jsx(ae,{url:c,tableState:l,columns:E,props:{noRecordsText:a._({id:"32o8IC"}),enableSelection:j,enableBulkDelete:j,tableActions:$,tableFilters:L,rowActions:J,params:{model_type:e,model_id:s}}},"attachment-table"),B&&C&&t.jsx(Z,{p:"md",shadow:"xs",radius:"md",children:t.jsx(f,{onDrop:G,loading:R,children:t.jsxs(z,{justify:"center",gap:"lg",mih:100,children:[t.jsx(f.Accept,{children:t.jsx(P,{style:{color:"var(--mantine-color-blue-6)"},stroke:1.5})}),t.jsx(f.Reject,{children:t.jsx(K,{style:{color:"var(--mantine-color-red-6)"},stroke:1.5})}),t.jsx(f.Idle,{children:t.jsx(P,{style:{color:"var(--mantine-color-dimmed)"},stroke:1.5})}),t.jsx(g,{size:"sm",children:a._({id:"1cbxaa"})})]})},"attachment-dropzone")})]})]})}function Ce({model_type:e,model_id:s}){return{name:"attachments",label:a._({id:"w/Sphq"}),icon:t.jsx(q,{}),content:e&&s?t.jsx(me,{model_type:e,model_id:s}):t.jsx(X,{})}}export{Ce as A};
//# sourceMappingURL=AttachmentPanel-cEo4FCl5.js.map
