import{r as a,n as z,j as e,i as o,cJ as D,G as C,B as _,I as q,eF as U,de as I,d as B,S as g,Y as P,bT as T,H as Q,aB as G,bW as O,bS as x,c2 as H,eH as Y,C as J,L as $,bR as K,cG as W,ek as v}from"./vendor-C9xuDR-n.js";import{A as S,m as V,e as k,p as X}from"./index-CjCZvRJF.js";import{u as Z}from"./UseInstance-DkyyiXzC.js";import{u as L}from"./UseStatusCodes-DAUHCqOs.js";import{S as N}from"./ThemeContext-s5vo4YrD.js";import{A as ee}from"./ActionButton-C7Sx5Rz-.js";import{P as te}from"./index-DNosoft8.js";import{u as se,R as re,a as le,I as ie}from"./InvenTreeTable-8QCr5F7I.js";import{Y as ae}from"./YesNoButton-BFXy69VD.js";import{u as M}from"./DesktopAppView-EZRUo9CM.js";import{u as oe,a as ne,B as de,S as ce,C as ue}from"./UseForm-D7tPXWOh.js";function pe({sessionId:s}){const{instance:t,setInstance:r,refreshInstance:d,instanceQuery:u}=Z({endpoint:S.import_session_list,pk:s,defaultValue:{}}),f=a.useCallback(l=>{r(l)},[]);L({modelType:V.importsession});const[p,h]=a.useState(0);a.useEffect(()=>{h(0)},[s]),a.useEffect(()=>{t.status&&t.status!==p&&h(t.status)},[t==null?void 0:t.status]);const c=a.useMemo(()=>(t==null?void 0:t.available_fields)??[],[t]),m=a.useMemo(()=>{let l=(t==null?void 0:t.columns)??[];return l=l.filter(i=>!!i),l=l.filter((i,n)=>l.indexOf(i)===n),l},[t.columns]),b=a.useMemo(()=>{var i;let l=((i=t==null?void 0:t.column_mappings)==null?void 0:i.map(n=>({...n,...c[n.field]??{}})))??[];return l=l.sort((n,j)=>n!=null&&n.required&&!(j!=null&&j.required)?-1:!(n!=null&&n.required)&&(j!=null&&j.required)?1:0),l},[t,m]),y=a.useMemo(()=>{var l;return((l=t==null?void 0:t.column_mappings)==null?void 0:l.filter(i=>!!i.column))??[]},[t]),w=a.useMemo(()=>(t==null?void 0:t.field_defaults)??{},[t]),F=a.useMemo(()=>(t==null?void 0:t.field_overrides)??{},[t]),R=a.useMemo(()=>(t==null?void 0:t.field_filters)??{},[t]),A=a.useMemo(()=>(t==null?void 0:t.row_count)??0,[t]),E=a.useMemo(()=>(t==null?void 0:t.completed_row_count)??0,[t]);return{sessionData:t,setSessionData:f,sessionId:s,refreshSession:d,sessionQuery:u,status:p,availableFields:c,availableColumns:m,columnMappings:b,mappedFields:y,fieldDefaults:w,fieldOverrides:F,fieldFilters:R,rowCount:A,completedRowCount:E}}function fe({session:s,column:t,row:r,onEdit:d}){const u=a.useCallback(c=>{X(c),r.complete||d==null||d()},[d,r]),f=a.useMemo(()=>r.errors?(r==null?void 0:r.errors[t.field])??[]:[],[r.errors,t.field]),p=a.useMemo(()=>{const c=s.availableFields[t.field];if(!(r!=null&&r.data))return"-";switch(c==null?void 0:c.type){case"boolean":return e.jsx(ae,{value:r.data?r.data[t.field]:!1});case"related field":if(c.model&&r.data[t.field])return e.jsx(de,{model:c.model,pk:r.data[t.field]});break}let m=r.data?r.data[t.field]??"":"";return m||(m="-"),m},[r.data,t.field,s.availableFields]),h=a.useMemo(()=>f.length==0,[f]);return e.jsxs(I,{disabled:h,openDelay:100,closeDelay:100,children:[e.jsx(I.Target,{children:e.jsx(C,{grow:!0,justify:"apart",onClick:u,children:e.jsx(C,{grow:!0,style:{flex:1},children:e.jsx(_,{size:"xs",c:h?void 0:"red",children:p})})})}),e.jsx(I.Dropdown,{children:e.jsx(g,{gap:"xs",children:f.map(c=>e.jsx(_,{size:"xs",c:"red",children:c},c))})})]})}function he({session:s}){const t=M(),r=se("dataimporter"),[d,u]=a.useState([]),f=a.useMemo(()=>{const l={};for(const i of d){const n=s.availableFields[i];if(n){let j=n.filters??{};if(s.fieldFilters[i]&&(j={...j,...s.fieldFilters[i]}),i=="id")continue;l[i]={...n,field_type:n.type,description:n.help_text,filters:j}}}return l},[d,s.availableFields,s.fieldFilters]),p=a.useCallback(l=>{z.show({title:o._({id:"fawxGh"}),message:o._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(D,{})}),t.post(k(S.import_session_accept_rows,s.sessionId),{rows:l}).catch(()=>{z.show({title:o._({id:"SlfejT"}),message:o._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{r.clearSelectedRecords(),z.hide("importing-rows"),r.refreshTable(),s.refreshSession()})},[s.sessionId,r.refreshTable]),[h,c]=a.useState({}),m=oe({url:S.import_session_row_list,pk:h.pk,title:o._({id:"bo3Q/V"}),fields:f,initialData:h.data,fetchInitialData:!1,processFormData:l=>({data:{...h.data,...l}}),onFormSuccess:l=>r.updateRecord(l)}),b=a.useCallback((l,i)=>{i.field!="id"&&(c(l),u([i.field]),m.open())},[s,m]),y=ne({url:S.import_session_row_list,pk:h.pk,title:o._({id:"f2AJjl"}),onFormSuccess:()=>r.refreshTable()}),w=a.useCallback(l=>{if(!l.errors)return[];const i=[];for(const n of Object.keys(l.errors))l.errors[n]&&(Array.isArray(l.errors[n])?l.errors[n].forEach(j=>{i.push(`${n}: ${j}`)}):i.push(l.errors[n].toString()));return i},[]),F=a.useMemo(()=>[{accessor:"row_index",title:o._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:i=>e.jsxs(C,{justify:"left",gap:"xs",children:[e.jsx(_,{size:"sm",children:i.row_index}),i.complete&&e.jsx(q,{color:"green",size:16}),!i.complete&&i.valid&&e.jsx(U,{color:"blue",size:16}),!i.complete&&!i.valid&&e.jsxs(I,{openDelay:50,closeDelay:100,position:"top-start",children:[e.jsx(I.Target,{children:e.jsx(B,{color:"red",size:16})}),e.jsx(I.Dropdown,{children:e.jsxs(g,{gap:"xs",children:[e.jsxs(_,{children:[o._({id:"H14AdY"}),":"]}),w(i).map(n=>e.jsx(_,{size:"sm",c:"red",children:n},n))]})})]})]})},...s.mappedFields.map(i=>({accessor:i.field,title:i.label??i.column,sortable:!1,switchable:!0,render:n=>e.jsx(fe,{session:s,column:i,row:n,onEdit:()=>b(n,i)})}))],[s]),R=a.useCallback(l=>[{title:o._({id:"g3UF2V"}),icon:e.jsx(D,{}),color:"green",hidden:l.complete||!l.valid,onClick:()=>{p([l.pk])}},re({hidden:l.complete,onClick:()=>{c(l),u(s.mappedFields.map(i=>i.field)),m.open()}}),le({onClick:()=>{c(l),y.open()}})],[s,p]),A=a.useMemo(()=>[{name:"valid",label:o._({id:"nfagfM"}),description:o._({id:"p385PV"}),type:"boolean"},{name:"complete",label:o._({id:"bD8I7O"}),description:o._({id:"ytCibL"}),type:"boolean"}],[]),E=a.useMemo(()=>{const l=r.hasSelectedRecords&&r.selectedRecords.every(i=>i.valid&&!i.complete);return[e.jsx(ee,{disabled:!l,icon:e.jsx(D,{}),color:"green",tooltip:o._({id:"Fgr3ay"}),onClick:()=>{p(r.selectedRecords.map(i=>i.pk))}},"import-selected-rows")]},[r.hasSelectedRecords,r.selectedRecords]);return e.jsxs(e.Fragment,{children:[m.modal,y.modal,e.jsxs(g,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(C,{grow:!0,justify:"apart",children:[e.jsx(_,{size:"lg",children:o._({id:"6dO0jk"})}),e.jsx(T,{}),e.jsx(te,{maximum:s.rowCount,value:s.completedRowCount,progressLabel:!0}),e.jsx(T,{})]})}),e.jsx(ie,{tableState:r,columns:F,url:k(S.import_session_row_list),props:{params:{session:s.sessionId},rowActions:R,tableActions:E,tableFilters:A,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{s.refreshSession()}}})]})]})}function me({column:s,options:t}){const r=M(),[d,u]=a.useState(""),[f,p]=a.useState(s.column??"");a.useEffect(()=>{p(s.column??"")},[s.column]);const h=a.useCallback(c=>{r.patch(k(S.import_session_column_mapping_list,s.pk),{column:c||""}).then(m=>{var b;p(((b=m.data)==null?void 0:b.column)??c),u("")}).catch(m=>{const b=m.response.data;u(b.column??b.non_field_errors??o._({id:"Vw8l6h"}))})},[s]);return e.jsx(H,{"aria-label":`import-column-map-${s.field}`,error:d,clearable:!0,searchable:!0,placeholder:o._({id:"TJu1/1"}),label:void 0,data:t,value:f,onChange:h})}function xe({fieldName:s,session:t}){const r=M(),d=a.useCallback(f=>{const p={...t.fieldDefaults,[s]:f};r.patch(k(S.import_session_list,t.sessionId),{field_defaults:p}).then(h=>{t.setSessionData(h.data)}).catch(()=>{})},[s,t,t.fieldDefaults]),u=a.useMemo(()=>{let f=t.availableFields[s];return f&&(f={...f,value:t.fieldDefaults[s],field_type:f.type,description:f.help_text,onValueChange:d}),f},[s,t.availableFields,t.fieldDefaults]);return u&&e.jsx(ce,{fieldDefinition:u,hideLabels:!0})}function je({session:s,column:t,options:r}){return e.jsxs(x.Tr,{children:[e.jsx(x.Td,{children:e.jsxs(C,{gap:"xs",children:[e.jsx(_,{fw:t.required?700:void 0,children:t.label??t.field}),t.required&&e.jsx(_,{c:"red",fw:700,children:"*"})]})}),e.jsx(x.Td,{children:e.jsx(_,{size:"sm",children:t.description})}),e.jsx(x.Td,{children:e.jsx(me,{column:t,options:r})}),e.jsx(x.Td,{children:e.jsx(xe,{fieldName:t.field,session:s})})]},t.label??t.field)}function _e({session:s}){const t=M(),[r,d]=a.useState(""),u=a.useCallback(()=>{const p=k(S.import_session_accept_fields,s.sessionId);t.post(p).then(()=>{s.refreshSession()}).catch(h=>{var c,m;d(((m=(c=h.response)==null?void 0:c.data)==null?void 0:m.error)??o._({id:"Vw8l6h"}))})},[s.sessionId]),f=a.useMemo(()=>[{value:"",label:o._({id:"ojDp4A"})},...s.availableColumns.map(p=>({value:p,label:p}))],[s.availableColumns]);return e.jsxs(g,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(C,{grow:!0,justify:"apart",children:[e.jsx(_,{size:"lg",children:o._({id:"AHjxLx"})}),e.jsx(T,{}),e.jsx(Q,{color:"green",variant:"filled",onClick:u,children:e.jsxs(C,{children:[e.jsx(G,{}),o._({id:"Y+Sfcf"})]})})]})}),r&&e.jsx(O,{color:"red",title:o._({id:"SlfejT"}),children:e.jsx(_,{children:r})}),e.jsxs(x,{children:[e.jsx(x.Thead,{children:e.jsxs(x.Tr,{children:[e.jsx(x.Th,{children:o._({id:"3mVQ03"})}),e.jsx(x.Th,{children:o._({id:"Us9epU"})}),e.jsx(x.Th,{children:o._({id:"qsUkVg"})}),e.jsx(x.Th,{children:o._({id:"aQ8swY"})})]})}),e.jsx(x.Tbody,{children:s.columnMappings.map(p=>e.jsx(je,{session:s,column:p,options:f},`import-${p.field}}`))})]})]})}function be({session:s}){const t=a.useMemo(()=>ue(V.importsession,s.status)||o._({id:"SC1Cur"}),[s.status]);return Y(()=>{s.refreshSession()},1e3,{autoInvoke:!0}),e.jsx(J,{style:{height:"100%"},children:e.jsxs(g,{gap:"xs",align:"center",justify:"center",children:[e.jsx(N,{size:"lg",children:t}),e.jsx($,{})]})})}function Se({currentStep:s}){return e.jsxs(v,{active:s,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(v.Step,{label:o._({id:"IQ3gAw"})}),e.jsx(v.Step,{label:o._({id:"KXVPhI"})}),e.jsx(v.Step,{label:o._({id:"FhMhTR"})}),e.jsx(v.Step,{label:o._({id:"eHQfWJ"})}),e.jsx(v.Step,{label:o._({id:"b8ESNU"})})]})}function Ae({sessionId:s,opened:t,onClose:r}){const d=pe({sessionId:s}),u=L({modelType:V.importsession}),f=a.useMemo(()=>{switch(d.status){case u.INITIAL:return 0;case u.MAPPING:return 1;case u.IMPORTING:return 2;case u.PROCESSING:return 3;case u.COMPLETE:return 4;default:return 0}},[d.status]),p=a.useMemo(()=>{if(d.sessionQuery.isError)return e.jsx(O,{color:"red",title:o._({id:"SlfejT"}),icon:e.jsx(B,{}),children:o._({id:"mfQdnw"})});switch(d.status){case u.MAPPING:return e.jsx(_e,{session:d});case u.PROCESSING:return e.jsx(he,{session:d});case u.COMPLETE:return e.jsxs(g,{gap:"xs",children:[e.jsx(O,{color:"green",title:o._({id:"4fgz8U"}),icon:e.jsx(G,{}),children:o._({id:"zdT9Dy"})}),e.jsx(Q,{color:"blue",onClick:r,children:o._({id:"yz7wBu"})})]});default:return e.jsx(be,{session:d})}},[d.status,d.sessionQuery]),h=a.useMemo(()=>{var c;return e.jsxs(g,{gap:"xs",style:{width:"100%"},children:[e.jsxs(C,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(N,{size:"lg",children:((c=d.sessionData)==null?void 0:c.statusText)??o._({id:"CTRRU5"})}),e.jsx(Se,{currentStep:f}),e.jsx(T,{})]}),e.jsx(K,{})]})},[d.sessionData]);return e.jsx(W,{position:"bottom",size:"80%",title:h,opened:t,onClose:r,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsx(g,{gap:"xs",children:e.jsx(P,{p:"md",children:p})})})}function Ee({modelType:s,allowUpdate:t=!1}){return{data_file:{},model_type:{value:s,hidden:s!=null},update_records:{hidden:t!==!0,value:t?void 0:!1},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{Ae as I,Ee as d};
//# sourceMappingURL=ImporterForms-WMn4m0-o.js.map
