{"version":3,"file":"ReturnOrderForms-Bu0gv7Wm.js","sources":["../../../../../../frontend/src/forms/ReturnOrderForms.tsx"],"sourcesContent":["import { t } from '@lingui/core/macro';\nimport { Flex, Table } from '@mantine/core';\nimport {\n  IconAddressBook,\n  IconCalendar,\n  IconSitemap,\n  IconUser,\n  IconUsers\n} from '@tabler/icons-react';\nimport { useMemo } from 'react';\n\nimport { ApiEndpoints } from '@lib/enums/ApiEndpoints';\nimport { ModelType } from '@lib/enums/ModelType';\nimport RemoveRowButton from '../components/buttons/RemoveRowButton';\nimport { StandaloneField } from '../components/forms/StandaloneField';\n\nimport { apiUrl } from '@lib/functions/Api';\nimport type {\n  ApiFormAdjustFilterType,\n  ApiFormFieldSet\n} from '@lib/types/Forms';\nimport type { TableFieldRowProps } from '../components/forms/fields/TableField';\nimport { Thumbnail } from '../components/images/Thumbnail';\nimport { useCreateApiFormModal } from '../hooks/UseForm';\nimport { useGlobalSettingsState } from '../states/SettingsStates';\nimport { StatusFilterOptions } from '../tables/Filter';\n\nexport function useReturnOrderFields({\n  duplicateOrderId\n}: {\n  duplicateOrderId?: number;\n}): ApiFormFieldSet {\n  const globalSettings = useGlobalSettingsState();\n\n  return useMemo(() => {\n    const fields: ApiFormFieldSet = {\n      reference: {},\n      description: {},\n      customer: {\n        disabled: duplicateOrderId != undefined,\n        filters: {\n          is_customer: true,\n          active: true\n        }\n      },\n      customer_reference: {},\n      project_code: {},\n      tenant: {\n        icon: <IconSitemap />,\n        filters: {\n          is_active: true\n        },\n        required: true\n      },\n      order_currency: {},\n      start_date: {\n        icon: <IconCalendar />\n      },\n      target_date: {\n        icon: <IconCalendar />\n      },\n      link: {},\n      contact: {\n        icon: <IconUser />,\n        adjustFilters: (value: ApiFormAdjustFilterType) => {\n          return {\n            ...value.filters,\n            company: value.data.customer\n          };\n        }\n      },\n      address: {\n        icon: <IconAddressBook />,\n        adjustFilters: (value: ApiFormAdjustFilterType) => {\n          return {\n            ...value.filters,\n            company: value.data.customer\n          };\n        }\n      },\n      responsible: {\n        filters: {\n          is_active: true\n        },\n        icon: <IconUsers />\n      }\n    };\n\n    // Order duplication fields\n    if (!!duplicateOrderId) {\n      fields.duplicate = {\n        children: {\n          order_id: {\n            hidden: true,\n            value: duplicateOrderId\n          },\n          copy_lines: {\n            // Cannot duplicate lines from a return order!\n            value: false,\n            hidden: true\n          },\n          copy_extra_lines: {}\n        }\n      };\n    }\n\n    if (!globalSettings.isSet('PROJECT_CODES_ENABLED', true)) {\n      delete fields.project_code;\n    }\n\n    return fields;\n  }, [duplicateOrderId, globalSettings]);\n}\n\nexport function useReturnOrderLineItemFields({\n  orderId,\n  customerId,\n  create\n}: {\n  orderId: number;\n  customerId: number;\n  create?: boolean;\n}) {\n  return useMemo(() => {\n    return {\n      order: {\n        disabled: true,\n        filters: {\n          customer_detail: true\n        }\n      },\n      item: {\n        filters: {\n          customer: customerId,\n          part_detail: true\n        }\n      },\n      quantity: {},\n      reference: {},\n      outcome: {\n        hidden: create == true\n      },\n      price: {},\n      price_currency: {},\n      target_date: {},\n      notes: {},\n      link: {}\n    };\n  }, [create, orderId, customerId]);\n}\n\ntype ReturnOrderLineItemsProps = {\n  items: any[];\n  orderId: number;\n  onFormSuccess: (data: any) => void;\n};\n\nfunction ReturnOrderLineItemFormRow({\n  props,\n  record\n}: Readonly<{\n  props: TableFieldRowProps;\n  record: any;\n}>) {\n  const statusOptions = useMemo(() => {\n    return (\n      StatusFilterOptions(ModelType.stockitem)()?.map((choice) => {\n        return {\n          value: choice.value,\n          display_name: choice.label\n        };\n      }) ?? []\n    );\n  }, []);\n\n  const quantityDisplay = useMemo(() => {\n    if (record.item_detail?.serial && record.quantity == 1) {\n      return `# ${record.item_detail.serial}`;\n    } else {\n      return record.quantity;\n    }\n  }, [record.quantity, record.item_detail]);\n\n  return (\n    <Table.Tr>\n      <Table.Td>\n        <Flex gap='sm' align='center'>\n          <Thumbnail\n            size={40}\n            src={record.part_detail.thumbnail}\n            align='center'\n          />\n          <div>{record.part_detail.name}</div>\n        </Flex>\n      </Table.Td>\n      <Table.Td>{quantityDisplay}</Table.Td>\n      <Table.Td>\n        <StandaloneField\n          fieldDefinition={{\n            field_type: 'choice',\n            label: t`Status`,\n            choices: statusOptions,\n            onValueChange: (value) => {\n              props.changeFn(props.idx, 'status', value);\n            }\n          }}\n          defaultValue={record.item_detail?.status}\n          error={props.rowErrors?.status?.message}\n        />\n      </Table.Td>\n      <Table.Td>\n        <RemoveRowButton onClick={() => props.removeFn(props.idx)} />\n      </Table.Td>\n    </Table.Tr>\n  );\n}\n\nexport function useReceiveReturnOrderLineItems(\n  props: ReturnOrderLineItemsProps\n) {\n  const fields: ApiFormFieldSet = {\n    id: {\n      value: props.orderId,\n      hidden: true\n    },\n    items: {\n      field_type: 'table',\n      value: props.items.map((item: any) => {\n        return {\n          item: item.pk\n        };\n      }),\n      modelRenderer: (row: TableFieldRowProps) => {\n        const record = props.items.find((item) => item.pk == row?.item?.item);\n\n        return (\n          <ReturnOrderLineItemFormRow\n            props={row}\n            record={record}\n            key={record.pk}\n          />\n        );\n      },\n      headers: [\n        { title: t`Part`, style: { minWidth: '250px' } },\n        { title: t`Quantity`, style: { minWidth: '250px' } },\n        { title: t`Status`, style: { minWidth: '250px' } },\n        { title: '', style: { width: '50px' } }\n      ]\n    },\n    location: {\n      filters: {\n        structural: false\n      }\n    }\n  };\n\n  return useCreateApiFormModal({\n    url: apiUrl(ApiEndpoints.return_order_receive, props.orderId),\n    title: t`Receive Items`,\n    fields: fields,\n    initialData: {\n      location: null\n    },\n    size: '80%',\n    onFormSuccess: props.onFormSuccess,\n    successMessage: t`Item received into stock`\n  });\n}\n"],"names":["useReturnOrderFields","duplicateOrderId","globalSettings","useGlobalSettingsState","useMemo","fields","reference","description","customer","disabled","undefined","filters","is_customer","active","customer_reference","project_code","tenant","icon","IconSitemap","is_active","required","order_currency","start_date","IconCalendar","target_date","link","contact","IconUser","adjustFilters","value","company","data","address","IconAddressBook","responsible","IconUsers","duplicate","children","order_id","hidden","copy_lines","copy_extra_lines","isSet","useReturnOrderLineItemFields","orderId","customerId","create","order","customer_detail","item","part_detail","quantity","outcome","price","price_currency","notes","ReturnOrderLineItemFormRow","props","record","statusOptions","StatusFilterOptions","ModelType","stockitem","map","choice","display_name","label","quantityDisplay","item_detail","serial","jsxs","Table","jsx","Flex","Thumbnail","thumbnail","name","StandaloneField","field_type","_i18n","_","id","choices","onValueChange","changeFn","idx","status","rowErrors","message","RemoveRowButton","removeFn","useReceiveReturnOrderLineItems","items","pk","modelRenderer","row","find","headers","title","style","minWidth","width","location","structural","useCreateApiFormModal","url","apiUrl","ApiEndpoints","return_order_receive","initialData","size","onFormSuccess","successMessage"],"mappings":"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"}
