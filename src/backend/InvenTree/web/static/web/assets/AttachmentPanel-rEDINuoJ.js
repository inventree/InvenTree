import{r as o,i as a,j as t,bg as V,aO as W,S as z,Y,G as U,dW as P,aT as Z,B as A,bU as K,n as x,I as N,d as Q,cz as X,bj as q}from"./vendor-C9xuDR-n.js";import{a as f}from"./NotesPanel-B2mDYO7F.js";import{A as M}from"./ActionButton-C7Sx5Rz-.js";import{P as H}from"./index-DNosoft8.js";import{u as y,R as ee,a as te,I as ae}from"./InvenTreeTable-8QCr5F7I.js";import{b as se,e as ne,A as oe}from"./index-CjCZvRJF.js";import{A as w}from"./AttachmentLink-DTUCNNKt.js";import{u as re}from"./DesktopAppView-EZRUo9CM.js";import{b as ie,u as le,a as ce,j as de}from"./UseForm-D7tPXWOh.js";function ue(){return[{accessor:"attachment",sortable:!1,switchable:!1,noWrap:!0,render:e=>e.attachment?t.jsx(w,{attachment:e.attachment}):e.link?t.jsx(w,{attachment:e.link,external:!0}):"-",noContext:!0},{accessor:"comment",sortable:!1,render:e=>e.comment},{accessor:"upload_date",sortable:!0,render:e=>t.jsxs(U,{justify:"space-between",children:[t.jsx(A,{children:e.upload_date}),e.user_detail&&t.jsx(K,{size:"xs",children:e.user_detail.username})]})},{accessor:"file_size",sortable:!0,switchable:!0,render:e=>e.attachment?de(e.file_size):"-"}]}function v({filename:e,progress:s}){return t.jsxs(z,{gap:"xs",children:[t.jsx(A,{size:"sm",children:a._({id:"XDpUYO",values:{filename:e}})}),t.jsx(H,{value:s,progressLabel:!1})]})}function me({model_type:e,model_id:s}){const _=re(),r=se(),l=y(`${e}-attachments`),E=o.useMemo(()=>ue(),[]),c=ne(oe.attachment_list),C=o.useMemo(()=>s>0,[s]),j=o.useMemo(()=>r.hasDeletePermission(e),[r,e]),[R,I]=o.useState(!1),B=o.useMemo(()=>r.hasAddPermission(e),[r,e]);function G(n){n.forEach(m=>{const h=new FormData;h.append("attachment",m),h.append("model_type",e),h.append("model_id",s.toString()),I(!0);const k=m.name,p=`attachment-upload-${e}-${s}-${m.name}`;x.show({id:p,title:a._({id:"hIFN6r"}),message:t.jsx(v,{filename:k,progress:0}),color:"blue",loading:!0,autoClose:!1}),_.post(c,h,{timeout:30*1e3,onUploadProgress:i=>{const O=100*((i==null?void 0:i.progress)??0);x.update({id:p,title:a._({id:"hIFN6r"}),color:"blue",loading:!0,autoClose:!1,message:t.jsx(v,{filename:k,progress:O})})}}).then(i=>(x.update({id:p,title:a._({id:"I1EiW4"}),message:a._({id:"JuMBMK",values:{name:k}}),color:"green",autoClose:3500,icon:t.jsx(N,{}),loading:!1}),l.refreshTable(),i)).catch(i=>(console.error("Error uploading attachment:",m,"->",i),x.update({id:p,title:a._({id:"ae3dey"}),message:a._({id:"GZnmeE"}),color:"red",autoClose:5e3,icon:t.jsx(Q,{}),loading:!1}),i)).finally(()=>{I(!1)})})}const[b,F]=o.useState("attachment"),[d,u]=o.useState(void 0),S=o.useMemo(()=>{const n={model_type:{value:e,hidden:!0},model_id:{value:s,hidden:!0},attachment:{},link:{},comment:{}};return b!="link"&&delete n.link,(b!="attachment"||d)&&delete n.attachment,n},[e,s,b,d]),g=ie({url:c,title:a._({id:"p1w/D6"}),fields:S,onFormSuccess:()=>{l.refreshTable()}}),T=le({url:c,pk:d,title:a._({id:"MVvhJ1"}),fields:S,onFormSuccess:n=>{n.pk?l.updateRecord(n):l.refreshTable()}}),D=ce({url:c,pk:d,title:a._({id:"hZfPb3"}),onFormSuccess:()=>{l.refreshTable()}}),L=o.useMemo(()=>[{name:"is_link",label:a._({id:"3QegpG"}),description:a._({id:"r1FQZj"})},{name:"is_file",label:a._({id:"JT83gz"}),description:a._({id:"5LI39K"})}],[]),$=o.useMemo(()=>[t.jsx(M,{tooltip:a._({id:"V8euYO"}),hidden:!r.hasAddPermission(e),icon:t.jsx(V,{}),onClick:()=>{F("attachment"),u(void 0),g.open()}},"add-attachment"),t.jsx(M,{tooltip:a._({id:"DpV4ac"}),hidden:!r.hasAddPermission(e),icon:t.jsx(W,{}),onClick:()=>{F("link"),u(void 0),g.open()}},"add-external-link")],[r,e]),J=o.useCallback(n=>[ee({hidden:!r.hasChangePermission(e),onClick:()=>{u(n.pk),T.open()}}),te({hidden:!j,onClick:()=>{u(n.pk),D.open()}})],[r,e]);return t.jsxs(t.Fragment,{children:[g.modal,T.modal,D.modal,t.jsxs(z,{gap:"xs",children:[C&&t.jsx(ae,{url:c,tableState:l,columns:E,props:{noRecordsText:a._({id:"32o8IC"}),enableSelection:j,enableBulkDelete:j,tableActions:$,tableFilters:L,rowActions:J,params:{model_type:e,model_id:s}}},"attachment-table"),B&&C&&t.jsx(Y,{p:"md",shadow:"xs",radius:"md",children:t.jsx(f,{onDrop:G,loading:R,children:t.jsxs(U,{justify:"center",gap:"lg",mih:100,children:[t.jsx(f.Accept,{children:t.jsx(P,{style:{color:"var(--mantine-color-blue-6)"},stroke:1.5})}),t.jsx(f.Reject,{children:t.jsx(Z,{style:{color:"var(--mantine-color-red-6)"},stroke:1.5})}),t.jsx(f.Idle,{children:t.jsx(P,{style:{color:"var(--mantine-color-dimmed)"},stroke:1.5})}),t.jsx(A,{size:"sm",children:a._({id:"1cbxaa"})})]})},"attachment-dropzone")})]})]})}function Ce({model_type:e,model_id:s}){return{name:"attachments",label:a._({id:"w/Sphq"}),icon:t.jsx(q,{}),content:e&&s?t.jsx(me,{model_type:e,model_id:s}):t.jsx(X,{})}}export{Ce as A};
//# sourceMappingURL=AttachmentPanel-rEDINuoJ.js.map
